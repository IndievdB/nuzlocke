<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Damage Calculator</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/js/app.js?v=2"></script>
</head>
<body x-data="calculator()" x-init="init()">
    <header>
        <h1>Pokemon Damage Calculator</h1>
        <nav>
            <a href="/calculator" class="active">Damage</a>
            <a href="/moves">Moves</a>
            <a href="/party">Party</a>
            <a href="/catch">Catch</a>
        </nav>
        <div class="generation-toggle">
            <label>
                <input type="radio" x-model="generation" value="3"> Gen 3
            </label>
            <label>
                <input type="radio" x-model="generation" value="9"> Gen 5+
            </label>
        </div>
    </header>

    <main class="calculator-layout">
        <!-- Attacker Panel -->
        <section class="pokemon-panel">
            <h2>Attacker</h2>

            <!-- Pokemon Search -->
            <div class="search-container">
                <input type="text"
                       x-model="attackerSearch"
                       @input.debounce.200ms="searchPokemon('attacker')"
                       @focus="showAttackerResults = attackerSearchResults.length > 0"
                       placeholder="Search Pokemon..."
                       autocomplete="off">
                <ul x-show="showAttackerResults && attackerSearchResults.length > 0"
                    class="search-results"
                    @click.away="showAttackerResults = false">
                    <template x-for="result in attackerSearchResults" :key="result.id">
                        <li @click="selectPokemon('attacker', result)" x-text="result.name"></li>
                    </template>
                </ul>
            </div>

            <!-- Form Selector -->
            <div x-show="attackerForms.length > 1" class="form-row">
                <label>Form:</label>
                <select @change="selectForm('attacker', $event.target.value)">
                    <template x-for="form in attackerForms" :key="form.id">
                        <option :value="form.id" :selected="attacker.species === form.id" x-text="form.name.includes('-') ? form.name.split('-').slice(1).join('-') || 'Base' : 'Base'"></option>
                    </template>
                </select>
            </div>

            <div x-show="attacker.species" class="pokemon-details">
                <!-- Level -->
                <div class="form-row">
                    <label>Level:</label>
                    <input type="number" x-model.number="attacker.level" min="1" max="100">
                </div>

                <!-- Nature -->
                <div class="form-row">
                    <label>Nature:</label>
                    <select x-model="attacker.nature">
                        <template x-for="nature in natures" :key="nature.id">
                            <option :value="nature.id" x-text="nature.name"></option>
                        </template>
                    </select>
                </div>
                <div class="nature-presets">
                    <button type="button" class="nature-btn" @click="setNature('attacker', 'atk')" :class="{ active: attacker.nature === 'adamant' }">+Atk</button>
                    <button type="button" class="nature-btn" @click="setNature('attacker', 'spa')" :class="{ active: attacker.nature === 'modest' }">+SpA</button>
                    <button type="button" class="nature-btn" @click="setNature('attacker', 'spe')" :class="{ active: attacker.nature === 'jolly' }">+Spe</button>
                </div>

                <!-- Ability -->
                <div class="form-row">
                    <label>Ability:</label>
                    <select x-model="attacker.ability" @change="fetchAbility(attacker.ability)">
                        <template x-for="ability in getAbilitiesList('attacker')" :key="ability.slot">
                            <option :value="ability.name" x-text="ability.name + (ability.hidden ? ' (H)' : '')"></option>
                        </template>
                    </select>
                </div>
                <p class="field-description" x-show="attacker.ability" x-text="getAbilityDescription('attacker')"></p>

                <!-- Item -->
                <div class="search-container">
                    <div class="form-row">
                        <label>Item:</label>
                        <input type="text"
                               x-model="attacker.item"
                               @input.debounce.200ms="searchItems('attacker')"
                               @focus="searchItems('attacker')"
                               placeholder="Item"
                               autocomplete="off">
                    </div>
                    <ul x-show="showAttackerItemResults && attackerItemResults.length > 0"
                        class="search-results"
                        @click.away="showAttackerItemResults = false">
                        <template x-for="item in attackerItemResults" :key="item.name">
                            <li @click="selectItem('attacker', item)" x-text="item.name"></li>
                        </template>
                    </ul>
                </div>
                <div class="item-presets">
                    <button type="button" class="item-btn" @click="attacker.item = 'Choice Band'; showAttackerItemResults = false" :class="{ active: attacker.item === 'Choice Band' }">C.Band</button>
                    <button type="button" class="item-btn" @click="attacker.item = 'Choice Specs'; showAttackerItemResults = false" :class="{ active: attacker.item === 'Choice Specs' }">C.Specs</button>
                    <button type="button" class="item-btn" @click="attacker.item = 'Life Orb'; showAttackerItemResults = false" :class="{ active: attacker.item === 'Life Orb' }">Life Orb</button>
                    <button type="button" class="item-btn" @click="attacker.item = ''; showAttackerItemResults = false" :class="{ active: !attacker.item }">None</button>
                </div>
                <p class="field-description" x-show="attacker.item && !showAttackerItemResults" x-text="getItemDescription('attacker')"></p>

                <!-- EVs -->
                <div class="stat-group">
                    <h4>EVs
                        <span class="iv-buttons" x-show="!attacker.unknownEvs">
                            <button type="button" class="iv-btn" @click="setAllEvs('attacker', 252)">252</button>
                            <button type="button" class="iv-btn" @click="setAllEvs('attacker', 0)">0</button>
                        </span>
                        <label class="unknown-toggle"><input type="checkbox" x-model="attacker.unknownEvs"> Unknown</label>
                    </h4>
                    <div class="stat-row" x-show="!attacker.unknownEvs">
                        <label>HP:</label><input type="number" x-model.number="attacker.evs.hp" min="0" max="252">
                        <label>Atk:</label><input type="number" x-model.number="attacker.evs.atk" min="0" max="252">
                        <label>Def:</label><input type="number" x-model.number="attacker.evs.def" min="0" max="252">
                    </div>
                    <div class="stat-row" x-show="!attacker.unknownEvs">
                        <label>SpA:</label><input type="number" x-model.number="attacker.evs.spa" min="0" max="252">
                        <label>SpD:</label><input type="number" x-model.number="attacker.evs.spd" min="0" max="252">
                        <label>Spe:</label><input type="number" x-model.number="attacker.evs.spe" min="0" max="252">
                    </div>
                    <div class="unknown-hint" x-show="attacker.unknownEvs">Will calculate 0-252 EV range</div>
                </div>

                <!-- IVs -->
                <div class="stat-group">
                    <h4>IVs
                        <span class="iv-buttons" x-show="!attacker.unknownIvs">
                            <button type="button" class="iv-btn" @click="setAllIvs('attacker', 31)">31</button>
                            <button type="button" class="iv-btn" @click="setAllIvs('attacker', 0)">0</button>
                        </span>
                        <label class="unknown-toggle"><input type="checkbox" x-model="attacker.unknownIvs"> Unknown</label>
                    </h4>
                    <div class="stat-row" x-show="!attacker.unknownIvs">
                        <label>HP:</label><input type="number" x-model.number="attacker.ivs.hp" min="0" max="31">
                        <label>Atk:</label><input type="number" x-model.number="attacker.ivs.atk" min="0" max="31">
                        <label>Def:</label><input type="number" x-model.number="attacker.ivs.def" min="0" max="31">
                    </div>
                    <div class="stat-row" x-show="!attacker.unknownIvs">
                        <label>SpA:</label><input type="number" x-model.number="attacker.ivs.spa" min="0" max="31">
                        <label>SpD:</label><input type="number" x-model.number="attacker.ivs.spd" min="0" max="31">
                        <label>Spe:</label><input type="number" x-model.number="attacker.ivs.spe" min="0" max="31">
                    </div>
                    <div class="unknown-hint" x-show="attacker.unknownIvs">Will calculate 0-31 IV range</div>
                </div>

                <!-- Boosts -->
                <div class="stat-group">
                    <h4>Boosts</h4>
                    <div class="stat-row">
                        <label>Atk:</label><input type="number" x-model.number="attacker.boosts.atk" min="-6" max="6">
                        <label>SpA:</label><input type="number" x-model.number="attacker.boosts.spa" min="-6" max="6">
                    </div>
                </div>

                <!-- Status -->
                <div class="form-row">
                    <label>Status:</label>
                    <select x-model="attacker.status">
                        <option value="">None</option>
                        <option value="brn">Burned</option>
                        <option value="par">Paralyzed</option>
                        <option value="psn">Poisoned</option>
                        <option value="tox">Badly Poisoned</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Move Panel -->
        <section class="move-panel">
            <h2>Move</h2>

            <!-- Swap Button -->
            <button @click="swapPokemon()" class="swap-btn" title="Swap Attacker and Defender">
                Swap
            </button>

            <!-- Move Selector (from learnset) -->
            <div x-show="attacker.species && attackerLearnset" class="move-selector">
                <select @change="selectLearnsetMove($event.target.value)" class="move-dropdown">
                    <option value="">Select a move...</option>

                    <!-- Level Up Moves -->
                    <template x-if="attackerLearnset?.levelup?.length > 0">
                        <optgroup label="Level Up">
                            <template x-for="m in sortedLevelUpMoves()" :key="'L' + m.move">
                                <option :value="m.move" :selected="move.name === m.move" x-text="formatMove(m.move, m.level)"></option>
                            </template>
                        </optgroup>
                    </template>

                    <!-- TM Moves -->
                    <template x-if="attackerLearnset?.tm?.length > 0">
                        <optgroup label="TM/HM">
                            <template x-for="moveId in sortedTMMoves()" :key="'TM' + moveId">
                                <option :value="moveId" :selected="move.name === moveId" x-text="formatMove(moveId)"></option>
                            </template>
                        </optgroup>
                    </template>

                    <!-- Tutor Moves -->
                    <template x-if="attackerLearnset?.tutor?.length > 0">
                        <optgroup label="Tutor">
                            <template x-for="moveId in sortedTutorMoves()" :key="'T' + moveId">
                                <option :value="moveId" :selected="move.name === moveId" x-text="formatMove(moveId)"></option>
                            </template>
                        </optgroup>
                    </template>

                    <!-- Egg Moves -->
                    <template x-if="attackerLearnset?.egg?.length > 0">
                        <optgroup label="Egg">
                            <template x-for="moveId in sortedEggMoves()" :key="'E' + moveId">
                                <option :value="moveId" :selected="move.name === moveId" x-text="formatMove(moveId)"></option>
                            </template>
                        </optgroup>
                    </template>
                </select>
            </div>

            <!-- Fallback: No Pokemon selected -->
            <div x-show="!attacker.species" class="move-placeholder">
                <p>Select an attacker to see moves</p>
            </div>

            <div x-show="move.name" class="move-details">
                <p class="move-description" x-text="getMoveDetails(move.name)?.shortDesc || getMoveDetails(move.name)?.desc || ''"></p>
                <div class="form-row">
                    <label>
                        <input type="checkbox" x-model="move.isCrit"> Critical Hit <span class="crit-chance" x-text="'(' + getCritChance() + ')'"></span>
                    </label>
                </div>
            </div>

            <!-- Field Conditions -->
            <h3>Field</h3>
            <div class="form-row">
                <label>Weather:</label>
                <select x-model="field.weather">
                    <option value="">None</option>
                    <option value="sun">Sun</option>
                    <option value="rain">Rain</option>
                    <option value="sand">Sandstorm</option>
                    <option value="snow">Snow</option>
                </select>
            </div>
            <div class="form-row">
                <label>Terrain:</label>
                <select x-model="field.terrain">
                    <option value="">None</option>
                    <option value="electric">Electric</option>
                    <option value="grassy">Grassy</option>
                    <option value="misty">Misty</option>
                    <option value="psychic">Psychic</option>
                </select>
            </div>
            <div class="checkbox-group">
                <label><input type="checkbox" x-model="field.defenderSide.reflect"> Reflect</label>
                <label><input type="checkbox" x-model="field.defenderSide.lightScreen"> Light Screen</label>
                <label><input type="checkbox" x-model="field.attackerSide.helpingHand"> Helping Hand</label>
            </div>

            <!-- Calculate Button -->
            <button @click="calculate()" class="calculate-btn" :disabled="!canCalculate()">
                Calculate Damage
            </button>
        </section>

        <!-- Defender Panel -->
        <section class="pokemon-panel">
            <h2>Defender</h2>

            <!-- Pokemon Search -->
            <div class="search-container">
                <input type="text"
                       x-model="defenderSearch"
                       @input.debounce.200ms="searchPokemon('defender')"
                       @focus="showDefenderResults = defenderSearchResults.length > 0"
                       placeholder="Search Pokemon..."
                       autocomplete="off">
                <ul x-show="showDefenderResults && defenderSearchResults.length > 0"
                    class="search-results"
                    @click.away="showDefenderResults = false">
                    <template x-for="result in defenderSearchResults" :key="result.id">
                        <li @click="selectPokemon('defender', result)" x-text="result.name"></li>
                    </template>
                </ul>
            </div>

            <!-- Form Selector -->
            <div x-show="defenderForms.length > 1" class="form-row">
                <label>Form:</label>
                <select @change="selectForm('defender', $event.target.value)">
                    <template x-for="form in defenderForms" :key="form.id">
                        <option :value="form.id" :selected="defender.species === form.id" x-text="form.name.includes('-') ? form.name.split('-').slice(1).join('-') || 'Base' : 'Base'"></option>
                    </template>
                </select>
            </div>

            <div x-show="defender.species" class="pokemon-details">
                <!-- Level -->
                <div class="form-row">
                    <label>Level:</label>
                    <input type="number" x-model.number="defender.level" min="1" max="100">
                </div>

                <!-- Nature -->
                <div class="form-row">
                    <label>Nature:</label>
                    <select x-model="defender.nature">
                        <template x-for="nature in natures" :key="nature.id">
                            <option :value="nature.id" x-text="nature.name"></option>
                        </template>
                    </select>
                </div>
                <div class="nature-presets">
                    <button type="button" class="nature-btn" @click="setNature('defender', 'def')" :class="{ active: defender.nature === 'bold' }">+Def</button>
                    <button type="button" class="nature-btn" @click="setNature('defender', 'spd')" :class="{ active: defender.nature === 'calm' }">+SpD</button>
                    <button type="button" class="nature-btn" @click="setNature('defender', 'spe')" :class="{ active: defender.nature === 'jolly' }">+Spe</button>
                </div>

                <!-- Ability -->
                <div class="form-row">
                    <label>Ability:</label>
                    <select x-model="defender.ability" @change="fetchAbility(defender.ability)">
                        <template x-for="ability in getAbilitiesList('defender')" :key="ability.slot">
                            <option :value="ability.name" x-text="ability.name + (ability.hidden ? ' (H)' : '')"></option>
                        </template>
                    </select>
                </div>
                <p class="field-description" x-show="defender.ability" x-text="getAbilityDescription('defender')"></p>

                <!-- Item -->
                <div class="search-container">
                    <div class="form-row">
                        <label>Item:</label>
                        <input type="text"
                               x-model="defender.item"
                               @input.debounce.200ms="searchItems('defender')"
                               @focus="searchItems('defender')"
                               placeholder="Item"
                               autocomplete="off">
                    </div>
                    <ul x-show="showDefenderItemResults && defenderItemResults.length > 0"
                        class="search-results"
                        @click.away="showDefenderItemResults = false">
                        <template x-for="item in defenderItemResults" :key="item.name">
                            <li @click="selectItem('defender', item)" x-text="item.name"></li>
                        </template>
                    </ul>
                </div>
                <div class="item-presets">
                    <button type="button" class="item-btn" @click="defender.item = 'Assault Vest'; showDefenderItemResults = false" :class="{ active: defender.item === 'Assault Vest' }">A.Vest</button>
                    <button type="button" class="item-btn" @click="defender.item = 'Eviolite'; showDefenderItemResults = false" :class="{ active: defender.item === 'Eviolite' }">Eviolite</button>
                    <button type="button" class="item-btn" @click="defender.item = ''; showDefenderItemResults = false" :class="{ active: !defender.item }">None</button>
                </div>
                <p class="field-description" x-show="defender.item && !showDefenderItemResults" x-text="getItemDescription('defender')"></p>

                <!-- EVs -->
                <div class="stat-group">
                    <h4>EVs
                        <span class="iv-buttons" x-show="!defender.unknownEvs">
                            <button type="button" class="iv-btn" @click="setAllEvs('defender', 252)">252</button>
                            <button type="button" class="iv-btn" @click="setAllEvs('defender', 0)">0</button>
                        </span>
                        <label class="unknown-toggle"><input type="checkbox" x-model="defender.unknownEvs"> Unknown</label>
                    </h4>
                    <div class="stat-row" x-show="!defender.unknownEvs">
                        <label>HP:</label><input type="number" x-model.number="defender.evs.hp" min="0" max="252">
                        <label>Atk:</label><input type="number" x-model.number="defender.evs.atk" min="0" max="252">
                        <label>Def:</label><input type="number" x-model.number="defender.evs.def" min="0" max="252">
                    </div>
                    <div class="stat-row" x-show="!defender.unknownEvs">
                        <label>SpA:</label><input type="number" x-model.number="defender.evs.spa" min="0" max="252">
                        <label>SpD:</label><input type="number" x-model.number="defender.evs.spd" min="0" max="252">
                        <label>Spe:</label><input type="number" x-model.number="defender.evs.spe" min="0" max="252">
                    </div>
                    <div class="unknown-hint" x-show="defender.unknownEvs">Will calculate 0-252 EV range</div>
                </div>

                <!-- IVs -->
                <div class="stat-group">
                    <h4>IVs
                        <span class="iv-buttons" x-show="!defender.unknownIvs">
                            <button type="button" class="iv-btn" @click="setAllIvs('defender', 31)">31</button>
                            <button type="button" class="iv-btn" @click="setAllIvs('defender', 0)">0</button>
                        </span>
                        <label class="unknown-toggle"><input type="checkbox" x-model="defender.unknownIvs"> Unknown</label>
                    </h4>
                    <div class="stat-row" x-show="!defender.unknownIvs">
                        <label>HP:</label><input type="number" x-model.number="defender.ivs.hp" min="0" max="31">
                        <label>Atk:</label><input type="number" x-model.number="defender.ivs.atk" min="0" max="31">
                        <label>Def:</label><input type="number" x-model.number="defender.ivs.def" min="0" max="31">
                    </div>
                    <div class="stat-row" x-show="!defender.unknownIvs">
                        <label>SpA:</label><input type="number" x-model.number="defender.ivs.spa" min="0" max="31">
                        <label>SpD:</label><input type="number" x-model.number="defender.ivs.spd" min="0" max="31">
                        <label>Spe:</label><input type="number" x-model.number="defender.ivs.spe" min="0" max="31">
                    </div>
                    <div class="unknown-hint" x-show="defender.unknownIvs">Will calculate 0-31 IV range</div>
                </div>

                <!-- Boosts -->
                <div class="stat-group">
                    <h4>Boosts</h4>
                    <div class="stat-row">
                        <label>Def:</label><input type="number" x-model.number="defender.boosts.def" min="-6" max="6">
                        <label>SpD:</label><input type="number" x-model.number="defender.boosts.spd" min="-6" max="6">
                    </div>
                </div>

                <!-- Current HP -->
                <div class="form-row">
                    <label>HP %:</label>
                    <input type="number" x-model.number="defenderHPPercent" min="1" max="100" placeholder="100">
                </div>
            </div>
        </section>
    </main>

    <!-- Results -->
    <section class="results-panel" x-show="result">
        <h2>Results</h2>
        <div class="result-content">
            <p class="damage-description" x-text="result?.description"></p>

            <!-- Single result (no unknowns) -->
            <template x-if="!result?.hasRange">
                <div class="damage-range">
                    <span class="damage-min" x-text="result?.minDamage + ' (' + result?.minPercent?.toFixed(1) + '%)'"></span>
                    <div class="damage-bar-container">
                        <div class="damage-bar damage-bar-min" :style="getMinBarStyle()"></div>
                        <div class="damage-bar damage-bar-range" :style="getRangeBarStyle()"></div>
                    </div>
                    <span class="damage-max" x-text="result?.maxDamage + ' (' + result?.maxPercent?.toFixed(1) + '%)'"></span>
                </div>
            </template>

            <!-- Range result (with unknowns) -->
            <template x-if="result?.hasRange">
                <div class="damage-range-multi">
                    <!-- Best case bar -->
                    <div class="damage-range-row">
                        <span class="range-label">Best case:</span>
                        <span class="damage-min" x-text="result?.bestMinDamage + '-' + result?.bestMaxDamage"></span>
                        <div class="damage-bar-container">
                            <div class="damage-bar damage-bar-best-min" :style="{ width: Math.min(result?.bestMinPercent, 100) + '%' }"></div>
                            <div class="damage-bar damage-bar-best-range" :style="{ width: Math.min(result?.bestMaxPercent - result?.bestMinPercent, 100 - result?.bestMinPercent) + '%' }"></div>
                        </div>
                        <span class="damage-max" x-text="result?.bestMinPercent?.toFixed(1) + '%-' + result?.bestMaxPercent?.toFixed(1) + '%'"></span>
                    </div>
                    <!-- Worst case bar -->
                    <div class="damage-range-row">
                        <span class="range-label">Worst case:</span>
                        <span class="damage-min" x-text="result?.worstMinDamage + '-' + result?.worstMaxDamage"></span>
                        <div class="damage-bar-container">
                            <div class="damage-bar damage-bar-worst-min" :style="{ width: Math.min(result?.worstMinPercent, 100) + '%' }"></div>
                            <div class="damage-bar damage-bar-worst-range" :style="{ width: Math.min(result?.worstMaxPercent - result?.worstMinPercent, 100 - result?.worstMinPercent) + '%' }"></div>
                        </div>
                        <span class="damage-max" x-text="result?.worstMinPercent?.toFixed(1) + '%-' + result?.worstMaxPercent?.toFixed(1) + '%'"></span>
                    </div>
                </div>
            </template>

            <!-- KO Information -->
            <div class="ko-info">
                <template x-if="!result?.hasRange">
                    <div>
                        <p><span class="ko-label">Best case:</span> <span class="ko-value" x-text="getBestCaseKO()"></span></p>
                        <p><span class="ko-label">Worst case:</span> <span class="ko-value" x-text="getWorstCaseKO()"></span></p>
                    </div>
                </template>
                <template x-if="result?.hasRange">
                    <div>
                        <p><span class="ko-label">Best case:</span> <span class="ko-value" x-text="getRangeKO('best')"></span></p>
                        <p><span class="ko-label">Worst case:</span> <span class="ko-value" x-text="getRangeKO('worst')"></span></p>
                    </div>
                </template>
            </div>

            <div x-show="result?.recoil" class="recoil-info">
                <p>Recoil: <span x-text="result?.recoil?.percent?.toFixed(1) + '%'"></span></p>
            </div>

            <div x-show="result?.recovery" class="recovery-info">
                <p>Recovery: <span x-text="result?.recovery?.minPercent?.toFixed(1) + '% - ' + result?.recovery?.maxPercent?.toFixed(1) + '%'"></span></p>
            </div>
        </div>
    </section>

    <footer>
        <p>Pokemon Damage Calculator - Using data from Pokemon Showdown</p>
    </footer>
</body>
</html>
